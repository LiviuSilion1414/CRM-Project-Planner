@page "/"
@page "/login"

@layout PublicLayout

@inject AuthService auth
@inject AuthService ls
@inject NotificationService ns
@inject NavigationManager nav
@inject DialogService ds

@attribute [AllowAnonymous]

<PageTitle>Login Page</PageTitle>
<RadzenStack JustifyContent="Radzen.JustifyContent.Center" Class="rz-mx-auto rz-p-4" Style="max-width: 1440px; height: 100%;">
    <RadzenCard class="rz-shadow-5 rz-border-radius-4" style="padding: 0; overflow: hidden">
        <RadzenRow Gap="0">
            <RadzenColumn Size="12" SizeSM="6" Class="rz-background-color-primary rz-p-12">
                <RadzenText TextStyle="TextStyle.H5" style="color:#fff; margin-top:30px;" Text="Entra nella tua area privata" />
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6" class="rz-p-12">
                <PageTitle>Login</PageTitle>
                <RadzenText Text="@("Login all'area riservata")" TextStyle="Radzen.Blazor.TextStyle.H5" class="mb-4" TagName="Radzen.Blazor.TagName.H2" />
                <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                    <RadzenColumn Size="12" SizeMD="12">
                        <RadzenFormField Text="Username" Variant="@Variant.Outlined" class="w-100">
                            <RadzenTextBox Name="Username" @bind-Value="@_model.EmailOrUsername" class="w-100" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenRow AlignItems="AlignItems.Center" RowGap="0.25rem">
                    <RadzenColumn Size="12" SizeMD="12">
                        <RadzenFormField Text="Password" Variant="Variant.Outlined" class="w-100">
                            <ChildContent>
                                <RadzenTextBox Name="Password" @bind-Value="@_model.Password" Visible="@(!showPassword)" class="w-100" />
                                <RadzenPassword Name="Password" @bind-Value="@_model.Password" Visible="@showPassword" class="w-100" />
                            </ChildContent>
                            <End>
                                <RadzenButton Icon="@(showPassword ? "visibility" : "visibility_off")" Click="TogglePassword" Variant="Variant.Text" Size="ButtonSize.Small" />
                            </End>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                <br />
                <br />
                <RadzenColumn Size="12" SizeMD="12">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Gap="0.5rem">
                        <RadzenButton ButtonType="ButtonType.Button" Click="@(OnLogin)" Text="Login" />
                        <RadzenButton Variant="Variant.Text" Text="Reset Password" Click="@(OnForgotPassword)" />
                    </RadzenStack>
                </RadzenColumn>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>
    <RadzenText Text="PlannerCRM v1.0, Copyright Ⓒ 2025" TextStyle="Radzen.Blazor.TextStyle.Caption" TextAlign="Radzen.TextAlign.Center" Style="width: 100%; margin-top: 20px;" TagName="Radzen.Blazor.TagName.P" />
</RadzenStack>

@code
{
    private EmployeeLoginDto _model;
    private EditContext _editContext;
    bool showPassword = false;

    protected override async Task OnInitializedAsync()
    {
        _model = new();
        _editContext = new(_model);

        await CheckIfLoggedIn();
    }

    void TogglePassword()
    {
        showPassword = !showPassword;
    }

    private async Task CheckIfLoggedIn()
    {
        var result = await auth.GetAuthenticationStateAsync();

        if (result.User is not null && result.User.Identity.IsAuthenticated)
        {
            nav.NavigateTo("home", true);
        }
    }

    private async Task OnLogin()
    {
        if (_editContext.Validate())
        {
            var res = await ls.LoginAsync(_model);

            if (res.IsSuccessStatusCode)
            {
                var authenticationState = await auth.GetAuthenticationStateAsync();
                ns.Notify(NotificationSeverity.Success, $"Welcome back, {authenticationState.User.Identity.Name}!", null, 4000);
                nav.NavigateTo("/home", true);
            }
            else
            {
                var responseContent = await res.Content.ReadAsStringAsync();
                ns.Notify(NotificationSeverity.Warning, "Something went wrong, please retry", responseContent, 4000);
            }
        }
    }

    private void OnForgotPassword()
    {
        nav.NavigateTo("/forgot-password");
    }
}
