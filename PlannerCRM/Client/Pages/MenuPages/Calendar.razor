@page "/calendar"

<h4>Calendar</h4>
<PageTitle>Calendar</PageTitle>

@if (fetch.IsBusy)
{
    <Loader />
}
else
{
    <RadzenScheduler TItem="ActivityDto"
                     Style="height: 90vh;"
                     Data=@_activities
                     Culture="CultureInfo.InvariantCulture"
                     SlotSelect="@OnAdd"
                     AppointmentSelect="@OnSelect"
                     StartProperty="@nameof(ActivityDto.StartDate)"
                     EndProperty="@nameof(ActivityDto.EndDate)"
                     TextProperty="@nameof(ActivityDto.Name)"
                     SelectedIndex="2">
        <RadzenDayView />
        <RadzenWeekView />
        <RadzenMonthView />
        <RadzenYearView />
    </RadzenScheduler>
}
@code {
    private List<ActivityDto> _activities = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            fetch.IsBusy = true;
            var filter = new SearchFilterDto()
                {
                    Limit = 100,
                    Offset = 0
                };

            var result = await fetch.ExecuteAsync(ActivityEndpointActions.GET_WITH_PAGINATION_BASE, filter, ApiType.Post);
            if (result.Data is not null)
            {
                _activities = JsonSerializer.Deserialize<List<ActivityDto>>(result.Data.ToString());
            }
            fetch.IsBusy = false;
        }
        catch (Exception ex)
        {
            notification.Notify(NotificationSeverity.Warning, "Something went wrong, please retry", null, 4000);
        }
    }

    private async Task OnSelect(SchedulerAppointmentSelectEventArgs<ActivityDto> args)
    {
        await dialog.OpenAsync<ActivityDialog>("Activity Information",
            new Dictionary<string, object>() { { nameof(ActivityDialog.SelectedActivity), args.Data } },
            new DialogOptions() { Width = "40vw;" }
        );
    }

    private async Task OnAdd(SchedulerSlotSelectEventArgs args)
    {
        await dialog.OpenAsync<ActivityAddForm>("Add Activity",
            new()
                {
                { nameof(ActivityAddForm.StartDate), args.Start },
                { nameof(ActivityAddForm.EndDate), args.End }
                },
            new DialogOptions() { Width = "40vw;" }
        );
    }
}